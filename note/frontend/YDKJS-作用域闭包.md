# 你不知道的 Javascript 作用域和闭包

## 作用域

![](../images/javascriot-scope-xmind.png)

作用域一般分为 `动态作用域` 和 `词法作用域`，**javascript 作用域为`词法作用域`**, 所以 javascript 的作用域在书写代码时已经决定了，当然还有欺骗词法作用域的手段(如 width eval)

动态作用域：在运行时决定作用域，即动态作用域决定性因素在调用栈；  
词法作用域: 在`词法解析`决定作用域，后续一般不会改变(存在特殊情况，`欺骗作用域`)，即决定性因素在书写嵌套；

词法解析存在于编译阶段，编译阶段一般分为 3 个步骤：

1. _词法解析_: 将源代码分为`词法单元`(token),解析完词法单元流(数组类型),一般还包含对单词的检查、优化等,如果是有状态的解析，则会赋予单词意义(例如 javascript 中的变量提升)；
2. _语法解析_: 将词法单元流转换为抽象语法树(AST)；
3. _代码生成_：将 AST 转换为可执行代码；

而 javascript 与其他编译型语言不同，它编译不是在构建当中，而是在执行前几毫秒内完成编译及优化；

在 javascript 中，作用域承担两个职责：

- 收集并维护声明标识符、查询标识符(`LHS RHS`)
- 根据严格规则，定义标识符的作用范围(`最小控制原则`)

编译器、引擎会和词法作用域交互流程如下

![](../images/javascript-scope.jpg)

按照如下示例代码解释流程
```
var a = 2;
var b = a;
```

在编译阶段，编译器会预解析声明语句：

- 编译器询问作用域，当前作用域下是否存在该变量；
- 当前作用域如果存在该变量，则继续编译；不存在该变量，则在当前作用域创建该变量；
- 如果是函数声明语句，则编译器还会处理函数声明值；而对于其他声明，则只处理变量；

该阶段后，作用域建立完成，进入代码执行阶段，由引擎执行

词法单元: 将语句解析为有意义的单词，如 var a = 2;解析后为 \[ var, a, =, 2, ; \](伪代码)
LHS:
RHS:
最小控制原则:
